<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ActionHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">poker-engine</a> &gt; <a href="index.source.html" class="el_package">de.simonaltschaeffl.poker.engine.component</a> &gt; <span class="el_source">ActionHandler.java</span></div><h1>ActionHandler.java</h1><pre class="source lang-java linenums">package de.simonaltschaeffl.poker.engine.component;

import de.simonaltschaeffl.poker.api.GameEventListener;
import de.simonaltschaeffl.poker.model.ActionType;
import de.simonaltschaeffl.poker.model.GameState;
import de.simonaltschaeffl.poker.model.Player;
import de.simonaltschaeffl.poker.model.PlayerStatus;
import de.simonaltschaeffl.poker.exception.InvalidActionException;

import java.util.List;

/**
 * Executes approved player actions and updates the {@link GameState}.
 * This class handles the actual chip movements between players and the pot,
 * updates player statuses (e.g., FOLDED, ALL_IN), and ensures that all
 * registered
 * {@link GameEventListener}s are notified of these state changes.
 *
 * &lt;p&gt;
 * Note: This class assumes that actions have already been validated by the
 * {@link RuleEngine} before execution.
 */
public class ActionHandler {
    private final List&lt;GameEventListener&gt; listeners;
    private final RuleEngine ruleEngine;

<span class="fc" id="L27">    public ActionHandler(List&lt;GameEventListener&gt; listeners, RuleEngine ruleEngine) {</span>
<span class="fc" id="L28">        this.listeners = listeners;</span>
<span class="fc" id="L29">        this.ruleEngine = ruleEngine;</span>
<span class="fc" id="L30">    }</span>

    /**
     * Executes the given action for a player, updating their chip stack, status,
     * and the game pot accordingly. It also notifies listeners of the event.
     *
     * @param player    The player performing the action.
     * @param type      The type of action to execute.
     * @param amount    The amount of chips involved (relevant for CALL, RAISE,
     *                  ALL_IN).
     * @param gameState The current state of the game.
     * @throws InvalidActionException If an attempt is made to post blinds via this
     *                                method.
     */
    public void executeAction(Player player, ActionType type, int amount, GameState gameState) {
<span class="fc" id="L45">        int balanceBefore = player.getChips();</span>
<span class="fc" id="L46">        int potTotalBefore = gameState.getPot().getTotal();</span>

        // Execution Logic
<span class="pc bpc" id="L49" title="2 of 7 branches missed.">        switch (type) {</span>
            case FOLD -&gt; {
<span class="fc bfc" id="L51" title="All 2 branches covered.">                if (player.getStatus() != PlayerStatus.LEFT) {</span>
<span class="fc" id="L52">                    player.setStatus(PlayerStatus.FOLDED);</span>
                }
            }
            case CHECK -&gt; {
                // No chip movement
<span class="fc" id="L57">            }</span>
            case CALL -&gt; {
<span class="fc" id="L59">                int highestBet = ruleEngine.getHighestRoundBet(gameState);</span>
<span class="fc" id="L60">                int toCall = highestBet - player.getCurrentBet();</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">                if (toCall &gt; player.getChips()) {</span>
                    // Treat as All-In (Partial Call)
<span class="nc" id="L63">                    amount = player.getChips();</span>
<span class="nc" id="L64">                    type = ActionType.ALL_IN;</span>
<span class="nc" id="L65">                    player.bet(amount);</span>
<span class="nc" id="L66">                    player.setStatus(PlayerStatus.ALL_IN);</span>
                } else {
<span class="fc" id="L68">                    player.bet(toCall);</span>
<span class="fc" id="L69">                    amount = toCall; // Actual amount bet</span>
                }
<span class="fc" id="L71">                gameState.getPot().add(player, amount);</span>
<span class="fc" id="L72">            }</span>
            case RAISE -&gt; {
<span class="fc" id="L74">                int toAdd = amount - player.getCurrentBet();</span>
<span class="fc" id="L75">                player.bet(toAdd);</span>
<span class="fc" id="L76">                gameState.getPot().add(player, toAdd);</span>
<span class="fc" id="L77">            }</span>
            case ALL_IN -&gt; {
<span class="fc" id="L79">                amount = player.getChips();</span>
<span class="fc" id="L80">                player.bet(amount);</span>
<span class="fc" id="L81">                gameState.getPot().add(player, amount);</span>
<span class="fc" id="L82">                player.setStatus(PlayerStatus.ALL_IN);</span>
<span class="fc" id="L83">            }</span>
<span class="nc" id="L84">            case SMALL_BLIND, BIG_BLIND -&gt; throw new InvalidActionException(&quot;Blinds should be posted via postBlind&quot;);</span>
        }

        // Notify
<span class="fc" id="L88">        notifyPlayerAction(player, type, amount, balanceBefore, player.getChips());</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (gameState.getPot().getTotal() != potTotalBefore) {</span>
<span class="fc" id="L90">            notifyPotUpdate(gameState.getPot().getTotal());</span>
        }
<span class="fc" id="L92">        notifyGameStateChanged(gameState);</span>

        // Mark as acted
<span class="fc" id="L95">        gameState.addActedPlayer(player);</span>
<span class="fc" id="L96">    }</span>

    /**
     * Deducts the blind amount from the player's stack and adds it to the pot.
     * This is handled separately from
     * {@link #executeAction(Player, ActionType, int, GameState)} as blinds are
     * forced
     * bets posted automatically at the start of a hand.
     *
     * @param player    The player posting the blind.
     * @param amount    The amount of the blind.
     * @param type      The type of blind (SMALL_BLIND or BIG_BLIND).
     * @param gameState The current state of the game.
     */
    public void postBlind(Player player, int amount, ActionType type, GameState gameState) {
<span class="fc" id="L111">        int balanceBefore = player.getChips();</span>
<span class="fc" id="L112">        player.bet(amount);</span>
<span class="fc" id="L113">        gameState.getPot().add(player, amount);</span>

<span class="fc" id="L115">        notifyPlayerAction(player, type, amount, balanceBefore, player.getChips());</span>
<span class="fc" id="L116">        notifyPotUpdate(gameState.getPot().getTotal());</span>
<span class="fc" id="L117">        notifyGameStateChanged(gameState);</span>
<span class="fc" id="L118">    }</span>

    private void notifyPlayerAction(Player p, ActionType type, int amount, int before, int after) {
<span class="fc" id="L121">        listeners.forEach(l -&gt; l.onPlayerAction(p, type, amount, before, after));</span>
<span class="fc" id="L122">    }</span>

    private void notifyPotUpdate(int total) {
<span class="fc" id="L125">        listeners.forEach(l -&gt; l.onPotUpdate(total));</span>
<span class="fc" id="L126">    }</span>

    private void notifyGameStateChanged(GameState gameState) {
<span class="fc" id="L129">        listeners.forEach(l -&gt; l.onGameStateChanged(gameState));</span>
<span class="fc" id="L130">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>